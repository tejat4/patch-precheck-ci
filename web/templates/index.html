<!--
  SPDX-License-Identifier: GPL-3.0-only

  Pre-PR CI - web/templates/index.html
  Single-page web UI — Vue.js frontend for triggering and monitoring CI jobs

  Copyright (C) 2025 Advanced Micro Devices, Inc.
  Author: Hemanth Selam <Hemanth.Selam@amd.com>

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, version 3.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-PR CI</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        /* Header */
        .header {
            background: white; border-radius: 16px; padding: 30px;
            margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .header-content {
            display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .status-info { display: flex; align-items: center; gap: 15px; }
        .status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 25px; font-size: 0.9rem;
            font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-badge.configured     { background: linear-gradient(135deg, #48bb78, #38a169); color: white; }
        .status-badge.not-configured { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }

        .config-info-btn {
            background: #667eea; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;
        }
        .config-info-btn:hover { background: #5a67d8; transform: translateY(-2px); }

        .refresh-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white; border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(17,153,142,0.4); }
        .refresh-btn i { transition: transform 0.3s; }
        .refresh-btn:hover i { transform: rotate(180deg); }

        /* Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .card-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;
        }
        .card-header i  { font-size: 1.5rem; color: #667eea; }
        .card-header h2 { color: #2d3748; font-size: 1.3rem; font-weight: 700; }

        /* Buttons */
        .action-section { margin-bottom: 20px; }
        .btn {
            width: 100%; background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; padding: 14px 24px; border-radius: 10px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn:disabled { background: linear-gradient(135deg, #cbd5e0, #a0aec0); cursor: not-allowed; transform: none; opacity: 0.6; }
        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-danger  { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .btn-stop {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            animation: pulse-stop 2s ease-in-out infinite;
        }
        .btn-stop:hover:not(:disabled) { animation: none; box-shadow: 0 6px 20px rgba(229,62,62,0.4); }
        @keyframes pulse-stop {
            0%, 100% { box-shadow: 0 4px 15px rgba(229,62,62,0.3); }
            50%       { box-shadow: 0 6px 25px rgba(229,62,62,0.6); }
        }
        .btn-small { padding: 8px 16px; font-size: 0.85rem; width: auto; }

        /* Progress */
        .progress-container {
            margin-top: 15px; padding: 15px; background: #f7fafc;
            border-radius: 10px; border-left: 4px solid #667eea;
        }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-status            { font-weight: 600; color: #2d3748; }
        .progress-status.running    { color: #667eea; }
        .progress-status.completed  { color: #48bb78; }
        .progress-status.failed     { color: #f56565; }
        .progress-status.killed     { color: #e53e3e; }
        .progress-bar { height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px; transition: width 0.3s ease;
        }
        .progress-fill.indeterminate { width: 30% !important; animation: indeterminate 1.5s ease-in-out infinite; }
        @keyframes indeterminate { 0% { transform: translateX(-100%); } 100% { transform: translateX(400%); } }
        .progress-actions { margin-top: 10px; display: flex; gap: 10px; }

        /* Test list */
        .test-grid { display: grid; gap: 12px; }
        .test-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; background: #f7fafc; border-radius: 10px;
            border-left: 4px solid #667eea; transition: all 0.3s;
        }
        .test-item:hover { background: #edf2f7; transform: translateX(5px); }
        .test-info { flex: 1; }
        .test-name { font-weight: 700; color: #2d3748; margin-bottom: 5px; }
        .test-desc { font-size: 0.85rem; color: #718096; }
        .test-actions { display: flex; gap: 8px; align-items: center; }
        .test-status-icon {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.75rem;
        }
        .test-status-icon.running   { background: #90cdf4; color: #2c5282; animation: pulse 1.5s ease-in-out infinite; }
        .test-status-icon.completed { background: #9ae6b4; color: #22543d; }
        .test-status-icon.failed    { background: #fc8181; color: #742a2a; }
        .test-status-icon.killed    { background: #feb2b2; color: #742a2a; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal {
            background: white; border-radius: 16px; padding: 30px;
            max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;
        }
        .modal-header h3 { color: #2d3748; font-size: 1.5rem; font-weight: 700; }
        .modal-close {
            background: none; border: none; font-size: 1.5rem; color: #718096;
            cursor: pointer; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; transition: all 0.3s;
        }
        .modal-close:hover { background: #f7fafc; color: #2d3748; }

        /* Form */
        .form-section { margin-bottom: 25px; }
        .form-section-title {
            color: #667eea; font-size: 1.1rem; font-weight: 700;
            margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; color: #2d3748; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0;
            border-radius: 8px; font-size: 1rem; transition: all 0.3s;
        }
        .form-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        /* Test Toggle */
        .test-toggle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .test-toggle-bulk   { display: flex; gap: 8px; }
        .btn-bulk { padding: 5px 14px; font-size: 0.78rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-bulk-enable        { background: #c6f6d5; color: #22543d; }
        .btn-bulk-enable:hover  { background: #9ae6b4; }
        .btn-bulk-disable       { background: #fed7d7; color: #742a2a; }
        .btn-bulk-disable:hover { background: #fc8181; color: white; }
        .test-toggle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 500px) { .test-toggle-grid { grid-template-columns: 1fr; } }
        .test-toggle-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; border-radius: 10px; border: 2px solid #e2e8f0;
            background: #f7fafc; transition: all 0.25s;
        }
        .test-toggle-item.enabled  { border-color: #68d391; background: #f0fff4; }
        .test-toggle-item.disabled { border-color: #fc8181; background: #fff5f5; opacity: 0.75; }
        .test-toggle-label { flex: 1; }
        .test-toggle-name  { font-weight: 700; font-size: 0.85rem; color: #2d3748; }
        .test-toggle-desc  { font-size: 0.74rem; color: #718096; margin-top: 2px; }
        .toggle-switch { position: relative; width: 42px; height: 22px; flex-shrink: 0; margin-left: 10px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: #fc8181; border-radius: 22px; transition: 0.3s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; width: 16px; height: 16px;
            left: 3px; bottom: 3px; background: white; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch input:checked + .toggle-slider          { background: #48bb78; }
        .toggle-switch input:checked + .toggle-slider::before  { transform: translateX(20px); }
        .enabled-badge { font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
        .enabled-badge.on  { background: #c6f6d5; color: #22543d; }
        .enabled-badge.off { background: #fed7d7; color: #742a2a; }

        /* Log viewer */
        .log-modal .modal { max-width: 1000px; }
        .log-output {
            background: #1a202c; color: #68d391; padding: 20px; border-radius: 10px;
            font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85rem;
            max-height: 500px; overflow-y: auto; white-space: pre-wrap;
            word-break: break-word; line-height: 1.5;
        }
        .log-output::-webkit-scrollbar       { width: 8px; }
        .log-output::-webkit-scrollbar-track { background: #2d3748; border-radius: 10px; }
        .log-output::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }

        /* Live badge */
        .live-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: #e53e3e; color: white; font-size: 0.65rem;
            font-weight: 800; letter-spacing: 0.06em;
            padding: 3px 10px; border-radius: 20px;
            margin-left: 10px; vertical-align: middle;
        }
        .live-dot {
            width: 7px; height: 7px; background: white; border-radius: 50%;
            display: inline-block; animation: live-pulse 1s ease-in-out infinite;
        }
        @keyframes live-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.3; transform: scale(0.65); }
        }

        /* Auto-scroll label */
        .autoscroll-label {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 0.8rem; color: #4a5568; cursor: pointer;
            user-select: none; white-space: nowrap;
        }
        .autoscroll-label input { accent-color: #667eea; width: 14px; height: 14px; cursor: pointer; }

        /* Config display */
        .config-display { background: #f7fafc; border-radius: 10px; padding: 20px; }
        .config-item    { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
        .config-item:last-child { border-bottom: none; }
        .config-label   { font-weight: 600; color: #4a5568; }
        .config-value   { color: #2d3748; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.9rem; }

        /* Utilities */
        .loading { text-align: center; padding: 40px; color: #718096; }
        .spinner {
            border: 3px solid #e2e8f0; border-top: 3px solid #667eea;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #718096; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.3; }
        .alert { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .alert-warning { background: #fef5e7; color: #856404; border-left: 4px solid #ed8936; }
        .select {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0;
            border-radius: 8px; font-size: 1rem; margin-bottom: 15px; transition: all 0.3s;
        }
        .select:focus { outline: none; border-color: #667eea; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }

        /* Footer */
        .footer { background: white; border-radius: 16px; padding: 25px 30px; margin-top: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .footer-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .footer-left    { flex: 1; min-width: 200px; }
        .footer-title   { font-weight: 700; font-size: 1.1rem; color: #2d3748; margin-bottom: 5px; }
        .footer-subtitle { font-size: 0.85rem; color: #718096; }
        .footer-center  { flex: 1; text-align: center; min-width: 250px; }
        .copyright      { font-size: 0.9rem; color: #4a5568; margin-bottom: 5px; }
        .copyright strong { color: #667eea; }
        .contact { font-size: 0.85rem; color: #718096; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .contact i { color: #667eea; }
        .contact a { color: #667eea; text-decoration: none; transition: color 0.3s; }
        .contact a:hover { color: #5a67d8; text-decoration: underline; }
        .footer-right { flex: 1; text-align: right; min-width: 150px; }
        .github-link {
            display: inline-flex; align-items: center; gap: 10px; padding: 10px 20px;
            background: #2d3748; color: white; text-decoration: none;
            border-radius: 8px; font-weight: 600; transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(45,55,72,0.2);
        }
        .github-link:hover { background: #1a202c; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(45,55,72,0.3); }
        .github-link i { font-size: 1.3rem; }
        @media (max-width: 768px) {
            .footer-content { flex-direction: column; text-align: center; }
            .footer-left, .footer-center, .footer-right { text-align: center; width: 100%; }
            .contact { justify-content: center; }
        }
    </style>
</head>
<body>
<div id="app">
    <div class="container">

        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <img src="/static/logo-horizontal.svg" alt="Pre-PR CI" height="120" style="margin-right:20px;">
                <div class="status-info">
                    <span class="status-badge" :class="systemStatus.configured ? 'configured' : 'not-configured'">
                        <i :class="systemStatus.configured ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
                        {{ systemStatus.configured ? 'Configured' : 'Not Configured' }}
                    </span>
                    <span v-if="systemStatus.distro" style="color:#718096;font-weight:600;">
                        {{ systemStatus.distro === 'anolis' ? 'OpenAnolis' : 'openEuler' }}
                    </span>
                    <button v-if="systemStatus.configured" class="config-info-btn" @click="showConfigInfo">
                        <i class="fas fa-info-circle"></i> View Config
                    </button>
                    <button class="refresh-btn" @click="refreshPage">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert -->
        <div v-if="!systemStatus.configured" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>System is not configured. Please select a distribution and configure the system first.</span>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">

            <!-- Left column -->
            <div>
                <!-- Configuration card -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header"><i class="fas fa-cog"></i><h2>Configuration</h2></div>
                    <select v-model="selectedDistro" class="select">
                        <option value="">Select Distribution</option>
                        <option value="anolis">OpenAnolis</option>
                        <option value="euler">openEuler</option>
                    </select>
                    <button class="btn" @click="configure" :disabled="!selectedDistro">
                        <i class="fas fa-cog"></i>
                        {{ systemStatus.configured ? 'Reconfigure' : 'Configure' }} System
                    </button>
                </div>

                <!-- Build card -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header"><i class="fas fa-hammer"></i><h2>Build</h2></div>
                    <div class="action-section">
                        <button class="btn btn-success" @click="runBuild" :disabled="!canRunBuild">
                            <i class="fas fa-play"></i> Run Build
                        </button>
                        <div v-if="buildJob.status" class="progress-container">
                            <div class="progress-header">
                                <span class="progress-status" :class="buildJob.status">
                                    <i :class="getStatusIcon(buildJob.status)"></i>
                                    {{ buildJob.status.toUpperCase() }}
                                </span>
                                <span style="font-size:0.85rem;color:#718096;">{{ buildJob.elapsed }}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill"
                                     :class="buildJob.status === 'running' ? 'indeterminate' : ''"
                                     :style="{width: buildJob.progress + '%'}"></div>
                            </div>
                            <div class="progress-actions">
                                <button class="btn btn-small" @click="showLog(buildJob.id)">
                                    <i class="fas fa-file-alt"></i> View Log
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Run All Tests card -->
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header"><i class="fas fa-vial"></i><h2>Run All Tests</h2></div>
                    <div class="action-section">
                        <button class="btn" @click="runAllTests"
                                :disabled="!systemStatus.configured || testAllJob.status === 'running'">
                            <i class="fas fa-play-circle"></i> Run All Tests
                        </button>
                        <div v-if="testAllJob.status" class="progress-container">
                            <div class="progress-header">
                                <span class="progress-status" :class="testAllJob.status">
                                    <i :class="getStatusIcon(testAllJob.status)"></i>
                                    {{ testAllJob.status.toUpperCase() }}
                                </span>
                                <span style="font-size:0.85rem;color:#718096;">{{ testAllJob.elapsed }}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill"
                                     :class="testAllJob.status === 'running' ? 'indeterminate' : ''"
                                     :style="{width: testAllJob.progress + '%'}"></div>
                            </div>
                            <div class="progress-actions">
                                <button class="btn btn-small" @click="showLog(testAllJob.id)">
                                    <i class="fas fa-file-alt"></i> View Log
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maintenance card -->
                <div class="card">
                    <div class="card-header"><i class="fas fa-wrench"></i><h2>Maintenance</h2></div>
                    <button class="btn btn-warning" @click="runClean" style="margin-bottom:10px;">
                        <i class="fas fa-broom"></i> Clean
                    </button>
                    <button class="btn btn-danger" @click="runReset" :disabled="!canRunReset" style="margin-bottom:10px;">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button v-if="hasRunningProcess" class="btn btn-stop" @click="stopRunningProcess">
                        <i class="fas fa-stop-circle"></i> Stop Running Process
                    </button>
                </div>
            </div>

            <!-- Right column: Available Tests -->
            <div class="card">
                <div class="card-header"><i class="fas fa-list-check"></i><h2>Available Tests</h2></div>

                <div v-if="loading" class="loading">
                    <div class="spinner"></div><p>Loading tests...</p>
                </div>

                <div v-else-if="!systemStatus.configured" class="empty-state">
                    <i class="fas fa-info-circle"></i>
                    <p>Please configure the system to see available tests</p>
                </div>

                <div v-else-if="tests.length > 0" class="test-grid">
                    <div v-for="test in tests" :key="test.name" class="test-item">
                        <div class="test-info">
                            <div class="test-name">{{ test.name }}</div>
                            <div class="test-desc">{{ test.description }}</div>
                        </div>
                        <div class="test-actions">
                            <div v-if="testJobs[test.name]" class="test-status-icon" :class="testJobs[test.name].status">
                                <i v-if="testJobs[test.name].status === 'running'"   class="fas fa-spinner fa-spin"></i>
                                <i v-else-if="testJobs[test.name].status === 'completed'" class="fas fa-check"></i>
                                <i v-else-if="testJobs[test.name].status === 'failed'"    class="fas fa-times"></i>
                                <i v-else-if="testJobs[test.name].status === 'killed'"    class="fas fa-ban"></i>
                            </div>
                            <button class="btn btn-small" @click="runTest(test.name)"
                                    :disabled="testJobs[test.name] && testJobs[test.name].status === 'running'">
                                <i class="fas fa-play"></i>
                            </button>
                            <button v-if="testJobs[test.name]" class="btn btn-small btn-warning"
                                    @click="showLog(testJobs[test.name].id)">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div v-else class="empty-state">
                    <i class="fas fa-inbox"></i><p>No tests available</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-content">
                <div class="footer-left">
                    <p class="footer-title">Pre-PR CI</p>
                    <p class="footer-subtitle">Automated kernel patch validation and testing</p>
                </div>
                <div class="footer-center">
                    <p class="copyright">© 2025 | Developed by <strong>Hemanth Selam</strong></p>
                    <p class="contact">
                        <i class="fas fa-envelope"></i>
                        <a href="mailto:Hemanth.Selam@amd.com">Hemanth.Selam@amd.com</a>
                    </p>
                </div>
                <div class="footer-right">
                    <a href="https://github.com/SelamHemanth" target="_blank" class="github-link">
                        <i class="fab fa-github"></i><span>SelamHemanth</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════
             Configuration Modal
             ══════════════════════════════════ -->
        <div v-if="showConfigModal" class="modal-overlay" @click.self="closeConfigModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-cog"></i>
                        Configure {{ selectedDistro === 'anolis' ? 'OpenAnolis' : 'openEuler' }}
                    </h3>
                    <button class="modal-close" @click="closeConfigModal"><i class="fas fa-times"></i></button>
                </div>

                <div v-if="loadingFields" class="loading">
                    <div class="spinner"></div><p>Loading configuration fields...</p>
                </div>

                <form v-else @submit.prevent="submitConfig">
                    <!-- General -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-file-alt"></i> General Configuration</div>
                        <div v-for="field in configFields.general" :key="field.name" class="form-group">
                            <label class="form-label">{{ field.label }}</label>
                            <select v-if="field.type === 'select'" v-model="configData[field.name]"
                                    class="form-input" :required="field.required">
                                <option value="">Select...</option>
                                <option v-for="opt in field.options" :key="opt" :value="opt">{{ opt }}</option>
                            </select>
                            <input v-else v-model="configData[field.name]" :type="field.type"
                                   :placeholder="field.default ? String(field.default) : ''"
                                   class="form-input" :required="field.required" />
                        </div>
                    </div>

                    <!-- Build -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-hammer"></i> Build Configuration</div>
                        <div v-for="field in configFields.build" :key="field.name" class="form-group">
                            <label class="form-label">{{ field.label }}</label>
                            <input v-model="configData[field.name]" :type="field.type"
                                   :placeholder="field.default ? String(field.default) : ''"
                                   class="form-input" :required="field.required" />
                        </div>
                    </div>

                    <!-- VM -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-desktop"></i> VM Configuration</div>
                        <div v-for="field in configFields.vm" :key="field.name" class="form-group">
                            <label class="form-label">{{ field.label }}</label>
                            <input v-model="configData[field.name]" :type="field.type"
                                   class="form-input" :required="field.required" />
                        </div>
                    </div>

                    <!-- Host -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-lock"></i> Host Configuration</div>
                        <div v-for="field in configFields.host" :key="field.name" class="form-group">
                            <label class="form-label">{{ field.label }}</label>
                            <input v-model="configData[field.name]" :type="field.type"
                                   class="form-input" :required="field.required" />
                        </div>
                    </div>

                    <!-- Test Selection -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-vial"></i>
                            Test Selection
                            <span style="font-size:0.75rem;font-weight:400;color:#718096;margin-left:6px;">
                                (all enabled by default)
                            </span>
                        </div>

                        <div class="test-toggle-header">
                            <span style="font-size:0.85rem;color:#4a5568;">
                                {{ enabledTestCount }} / {{ testToggles.length }} tests enabled
                            </span>
                            <div class="test-toggle-bulk">
                                <button type="button" class="btn-bulk btn-bulk-enable" @click="enableAllTests">
                                    <i class="fas fa-check-double"></i> Enable All
                                </button>
                                <button type="button" class="btn-bulk btn-bulk-disable" @click="disableAllTests">
                                    <i class="fas fa-times"></i> Disable All
                                </button>
                            </div>
                        </div>

                        <div class="test-toggle-grid">
                            <div v-for="t in testToggles" :key="t.key"
                                 class="test-toggle-item" :class="t.enabled ? 'enabled' : 'disabled'">
                                <div class="test-toggle-label">
                                    <div class="test-toggle-name">{{ t.label }}</div>
                                    <div class="test-toggle-desc">{{ t.desc }}</div>
                                    <span class="enabled-badge" :class="t.enabled ? 'on' : 'off'">
                                        {{ t.enabled ? 'ENABLED' : 'DISABLED' }}
                                    </span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" v-model="t.enabled" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn" style="background:#cbd5e0;color:#2d3748;" @click="closeConfigModal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ══════════════════════════════════
             Config Info Modal
             ══════════════════════════════════ -->
        <div v-if="showConfigInfoModal" class="modal-overlay" @click.self="showConfigInfoModal = false">
            <div class="modal">
                <div class="modal-header">
                    <h3><i class="fas fa-info-circle"></i> Current Configuration</h3>
                    <button class="modal-close" @click="showConfigInfoModal = false"><i class="fas fa-times"></i></button>
                </div>
                <div v-if="loadingConfig" class="loading">
                    <div class="spinner"></div><p>Loading configuration...</p>
                </div>
                <div v-else class="config-display">
                    <div v-for="(value, key) in currentConfig" :key="key" class="config-item">
                        <span class="config-label">{{ formatConfigKey(key) }}</span>
                        <span class="config-value">{{ value }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════
             Log Viewer Modal  (live streaming)
             ══════════════════════════════════ -->
        <div v-if="showLogModal" class="modal-overlay log-modal" @click.self="closeLogModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-file-alt"></i>
                        Job Log
                        <span v-if="logIsLive" class="live-badge">
                            <span class="live-dot"></span> LIVE
                        </span>
                    </h3>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <label v-if="logIsLive" class="autoscroll-label">
                            <input type="checkbox" v-model="logAutoScroll" />
                            Auto-scroll
                        </label>
                        <button class="modal-close" @click="closeLogModal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div v-if="loadingLog" class="loading">
                    <div class="spinner"></div><p>Loading log...</p>
                </div>
                <div v-else
                     ref="logOutputEl"
                     class="log-output"
                     @scroll="onLogScroll">{{ currentLog || 'No log output yet...' }}</div>
            </div>
        </div>

    </div>
</div>

<script>
const { createApp } = Vue;

/* Per-distro test definitions */
const TEST_DEFS = {
    anolis: [
        { key: 'CHECK_DEPENDENCY', label: 'check_dependency',       desc: 'Check patch dependencies' },
        { key: 'CHECK_KCONFIG',    label: 'check_kconfig',          desc: 'Validate kernel configuration' },
        { key: 'BUILD_ALLYES',     label: 'build_allyes_config',    desc: 'Build with allyesconfig' },
        { key: 'BUILD_ALLNO',      label: 'build_allno_config',     desc: 'Build with allnoconfig' },
        { key: 'BUILD_DEFCONFIG',  label: 'build_anolis_defconfig', desc: 'Build with anolis_defconfig' },
        { key: 'BUILD_DEBUG',      label: 'build_anolis_debug',     desc: 'Build with anolis-debug_defconfig' },
        { key: 'RPM_BUILD',        label: 'anck_rpm_build',         desc: 'Build ANCK RPM packages' },
        { key: 'CHECK_KAPI',       label: 'check_kapi',             desc: 'Check kernel ABI compatibility' },
        { key: 'BOOT_KERNEL',      label: 'boot_kernel_rpm',        desc: 'Boot VM with built kernel RPM' }
    ],
    euler: [
        { key: 'CHECK_DEPENDENCY', label: 'check_dependency', desc: 'Check patch dependencies' },
        { key: 'BUILD_ALLMOD',     label: 'build_allmod',     desc: 'Build with allmodconfig' },
        { key: 'CHECK_KABI',       label: 'check_kabi',       desc: 'Check KABI whitelist' },
        { key: 'CHECK_PATCH',      label: 'check_patch',      desc: 'Run checkpatch.pl validation' },
        { key: 'CHECK_FORMAT',     label: 'check_format',     desc: 'Check code formatting' },
        { key: 'RPM_BUILD',        label: 'rpm_build',        desc: 'Build openEuler RPM packages' },
        { key: 'BOOT_KERNEL',      label: 'boot_kernel',      desc: 'Boot test (requires remote setup)' }
    ]
};

createApp({
    data() {
        return {
            systemStatus:        { configured: false, distro: null },
            selectedDistro:      '',
            tests:               [],
            jobs:                [],
            testJobs:            {},
            buildJob:            {},
            testAllJob:          {},
            loading:             false,
            pollInterval:        null,
            showConfigModal:     false,
            showConfigInfoModal: false,
            showLogModal:        false,
            loadingFields:       false,
            loadingConfig:       false,
            loadingLog:          false,
            configFields:        { general: [], build: [], vm: [], host: [] },
            configData:          {},
            currentConfig:       {},
            currentLog:          '',
            buildHasRun:         false,
            testToggles:         [],
            /* live-log */
            logPollInterval:     null,
            currentLogJobId:     null,
            logIsLive:           false,
            logAutoScroll:       true
        };
    },

    computed: {
        canRunBuild() {
            return this.systemStatus.configured &&
                   (!this.buildHasRun || this.buildJob.status !== 'running');
        },
        canRunReset() {
            return this.buildHasRun && this.buildJob.status !== 'running';
        },
        hasRunningProcess() {
            if (this.buildJob.status   === 'running') return true;
            if (this.testAllJob.status === 'running') return true;
            return Object.values(this.testJobs).some(j => j.status === 'running');
        },
        enabledTestCount() {
            return this.testToggles.filter(t => t.enabled).length;
        }
    },

    mounted() {
        this.loadStatus();
        this.loadTests();
        this.loadJobs();
        this.pollInterval = setInterval(() => {
            this.loadJobs();
            this.updateJobProgress();
        }, 2000);
    },

    beforeUnmount() {
        if (this.pollInterval) clearInterval(this.pollInterval);
        this.stopLogPoll();
    },

    methods: {

        /* ── Status / Tests / Jobs ── */

        async loadStatus() {
            try {
                const r = await axios.get('/api/status');
                this.systemStatus = r.data;
                if (this.systemStatus.configured) this.loadTests();
            } catch (e) { console.error('loadStatus', e); }
        },

        async loadTests() {
            if (!this.systemStatus.configured) return;
            this.loading = true;
            try {
                const r = await axios.get('/api/tests');
                this.tests = r.data.tests || [];
            } catch (e) { console.error('loadTests', e); }
            finally     { this.loading = false; }
        },

        async loadJobs() {
            try {
                const r = await axios.get('/api/jobs');
                this.jobs = r.data;
                this.categorizeJobs();
            } catch (e) { console.error('loadJobs', e); }
        },

        categorizeJobs() {
            const byTime = (a, b) => new Date(b.created_time) - new Date(a.created_time);

            const buildJob   = this.jobs.filter(j => j.command === 'make build').sort(byTime)[0];
            const testAllJob = this.jobs.filter(j => j.command === 'make test').sort(byTime)[0];

            if (buildJob) {
                this.buildJob = { ...buildJob, elapsed: this.calcElapsed(buildJob) };
                if (['running','completed','failed','killed'].includes(buildJob.status))
                    this.buildHasRun = true;
            } else {
                this.buildJob = {};
            }

            this.testAllJob = testAllJob
                ? { ...testAllJob, elapsed: this.calcElapsed(testAllJob) }
                : {};

            this.jobs.forEach(j => {
                if (j.test_name)
                    this.testJobs[j.test_name] = { ...j, elapsed: this.calcElapsed(j) };
            });
        },

        calcElapsed(job) {
            if (!job.start_time) return '';
            const start = new Date(job.start_time);
            const end   = job.end_time ? new Date(job.end_time) : new Date();
            const diff  = Math.floor((end - start) / 1000);
            return `${Math.floor(diff / 60)}m ${diff % 60}s`;
        },

        updateJobProgress() {
            if (['completed','failed','killed'].includes(this.buildJob.status))
                this.buildJob.progress = 100;
            if (['completed','failed','killed'].includes(this.testAllJob.status))
                this.testAllJob.progress = 100;
        },

        getStatusIcon(status) {
            return {
                running:   'fas fa-spinner fa-spin',
                completed: 'fas fa-check-circle',
                failed:    'fas fa-times-circle',
                queued:    'fas fa-clock',
                killed:    'fas fa-ban'
            }[status] || 'fas fa-question-circle';
        },

        /* ── Live Log ── */

        isJobRunning(jobId) {
            if (this.buildJob.id   === jobId && this.buildJob.status   === 'running') return true;
            if (this.testAllJob.id === jobId && this.testAllJob.status === 'running') return true;
            return Object.values(this.testJobs).some(j => j.id === jobId && j.status === 'running');
        },

        async fetchLog(jobId) {
            try {
                const r = await axios.get(`/api/jobs/${jobId}/log`);
                this.currentLog = r.data.log || '';
                await this.$nextTick();
                if (this.logAutoScroll) this.scrollLogBottom();
            } catch (_) { /* ignore transient poll errors */ }
        },

        stopLogPoll() {
            if (this.logPollInterval) {
                clearInterval(this.logPollInterval);
                this.logPollInterval = null;
            }
            this.logIsLive = false;
        },

        startLogPoll(jobId) {
            if (!this.isJobRunning(jobId)) {
                this.logIsLive = false;
                return;
            }
            this.logIsLive = true;
            this.logPollInterval = setInterval(async () => {
                if (!this.showLogModal || this.currentLogJobId !== jobId) {
                    this.stopLogPoll();
                    return;
                }
                await this.fetchLog(jobId);
                if (!this.isJobRunning(jobId)) {
                    this.stopLogPoll();
                    await this.fetchLog(jobId); /* capture final tail */
                }
            }, 1500);
        },

        async showLog(jobId) {
            this.stopLogPoll();
            this.currentLog      = '';
            this.currentLogJobId = jobId;
            this.logAutoScroll   = true;
            this.showLogModal    = true;
            this.loadingLog      = true;

            await this.fetchLog(jobId);
            this.loadingLog = false;

            this.startLogPoll(jobId);
        },

        closeLogModal() {
            this.stopLogPoll();
            this.showLogModal    = false;
            this.currentLog      = '';
            this.currentLogJobId = null;
        },

        scrollLogBottom() {
            const el = this.$refs.logOutputEl;
            if (el) el.scrollTop = el.scrollHeight;
        },

        onLogScroll() {
            const el = this.$refs.logOutputEl;
            if (!el) return;
            /* re-enable auto-scroll when user scrolls back to bottom */
            this.logAutoScroll = (el.scrollHeight - el.scrollTop - el.clientHeight) < 40;
        },

        /* ── Configuration ── */

        buildTestToggles(distro) {
            this.testToggles = (TEST_DEFS[distro] || []).map(d => ({ ...d, enabled: true }));
        },
        enableAllTests()  { this.testToggles.forEach(t => t.enabled = true);  },
        disableAllTests() { this.testToggles.forEach(t => t.enabled = false); },

        async configure() {
            if (!this.selectedDistro) { alert('Please select a distribution first'); return; }
            this.showConfigModal = true;
            this.loadingFields   = true;
            try {
                const r = await axios.get('/api/config/fields', { params: { distro: this.selectedDistro } });
                this.configFields = r.data.fields;
                this.configData   = {};
                Object.values(this.configFields).forEach(section =>
                    section.forEach(f => { if (f.default !== undefined) this.configData[f.name] = f.default; })
                );
                this.buildTestToggles(this.selectedDistro);
            } catch (_) {
                alert('Failed to load configuration fields');
                this.showConfigModal = false;
            } finally {
                this.loadingFields = false;
            }
        },

        closeConfigModal() {
            this.showConfigModal = false;
            this.configData      = {};
            this.testToggles     = [];
        },

        async submitConfig() {
            const testFlags = {};
            this.testToggles.forEach(t => {
                testFlags[`TEST_${t.key}`] = t.enabled ? 'yes' : 'no';
            });
            try {
                await axios.post('/api/config', {
                    distro:     this.selectedDistro,
                    config:     this.configData,
                    test_flags: testFlags
                });
                alert('Configuration saved successfully!');
                this.closeConfigModal();
                this.loadStatus();
            } catch (_) { alert('Configuration failed'); }
        },

        async showConfigInfo() {
            this.showConfigInfoModal = true;
            this.loadingConfig       = true;
            try {
                const r = await axios.get('/api/config');
                this.currentConfig = r.data;
            } catch (_) {
                alert('Failed to load configuration');
                this.showConfigInfoModal = false;
            } finally {
                this.loadingConfig = false;
            }
        },

        formatConfigKey(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        },

        /* ── Actions ── */

        async runBuild() {
            if (!this.canRunBuild) return;
            try {
                this.buildJob = {};
                await axios.post('/api/build');
                this.loadJobs();
            } catch (_) { alert('Failed to start build'); }
        },

        async runAllTests() {
            try {
                this.testAllJob = {};
                await axios.post('/api/test/all');
                this.loadJobs();
            } catch (_) { alert('Failed to start tests'); }
        },

        async runTest(testName) {
            try {
                await axios.post(`/api/test/${testName}`);
                this.loadJobs();
            } catch (_) { alert('Failed to start test'); }
        },

        async runClean() {
            if (!confirm(
                '⚠️ Clean Operation\n\nThis will remove:\n' +
                '• logs/ directory\n• patches/ directory\n• Build artifacts\n\nDo you want to continue?'
            )) return;
            try {
                await axios.post('/api/clean');
                alert('✓ Clean operation started successfully!');
                this.loadJobs();
            } catch (e) { alert('❌ Failed to start clean operation: ' + e.message); }
        },

        async runReset() {
            if (!this.canRunReset) return;
            if (!confirm(
                '⚠️ Reset Operation\n\nThis will reset the git repository to the saved HEAD commit.\n' +
                'All uncommitted changes will be lost!\n\nAre you absolutely sure?'
            )) return;
            if (!confirm('⚠️ FINAL CONFIRMATION\n\nThis action cannot be undone.\nClick OK to proceed with reset.')) return;
            try {
                this.buildHasRun = false;
                this.buildJob    = {};
                await axios.post('/api/reset');
                alert('✓ Reset operation started successfully!');
                this.loadJobs();
            } catch (e) { alert('❌ Failed to start reset operation: ' + e.message); }
        },

        async stopRunningProcess() {
            if (!confirm(
                '⚠️ STOP RUNNING PROCESS\n\n' +
                'This will terminate the currently running process immediately.\n\nDo you want to continue?'
            )) return;
            if (!confirm('⚠️ FINAL CONFIRMATION\n\nClick OK to stop the process.')) return;
            try {
                let runningJobId = null;
                if      (this.buildJob.status   === 'running') runningJobId = this.buildJob.id;
                else if (this.testAllJob.status === 'running') runningJobId = this.testAllJob.id;
                else {
                    for (const job of Object.values(this.testJobs)) {
                        if (job.status === 'running') { runningJobId = job.id; break; }
                    }
                }
                if (!runningJobId) { alert('No running process found'); return; }
                await axios.post(`/api/jobs/${runningJobId}/kill`);
                alert('✓ Process stopped successfully!');
                this.loadJobs();
            } catch (e) {
                alert('❌ Failed to stop process: ' + (e.response?.data?.error || e.message));
            }
        },

        refreshPage() { location.reload(); }
    }
}).mount('#app');
</script>
</body>
</html>
